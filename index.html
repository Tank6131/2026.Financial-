<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2026 年度資產負債財務儀表板</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap");
    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: #020617;
      background-image: radial-gradient(circle at 2px 2px, rgba(212, 175, 55, 0.05) 1px, transparent 0);
      background-size: 40px 40px;
      color: #f8fafc;
    }
    .gold-gradient-text {
      background: linear-gradient(to right, #d4af37, #fde68a, #d4af37);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .card-bg {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(212, 175, 55, 0.2);
      backdrop-filter: blur(10px);
    }
    .gold-border { border-left: 4px solid #d4af37; }

    #loader {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #020617;
      display: flex; justify-content: center; align-items: center;
      z-index: 100; transition: opacity 0.5s;
    }
  </style>
</head>

<body class="p-4 md:p-8 min-h-screen">
  <div id="loader">
    <div class="text-amber-500 animate-pulse text-xl font-bold">
      同步 Google Sheets 數據中...
    </div>
  </div>

  <header class="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-center border-b border-yellow-900/30 pb-6">
    <div>
      <h1 class="text-3xl md:text-4xl font-bold gold-gradient-text mb-2">2026 年度資產負債總覽</h1>
      <p class="text-slate-400 flex items-center gap-2">
        <i data-lucide="calendar" class="w-4 h-4"></i>
        數據更新至：<span id="latest-month" class="text-amber-200 font-medium">---</span>
      </p>
    </div>

    <div class="mt-4 md:mt-0 px-4 py-2 rounded-full bg-amber-500/10 border border-amber-500/20 text-amber-500 text-sm font-medium">
      <span class="flex items-center gap-2">
        <span class="relative flex h-3 w-3">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-amber-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-3 w-3 bg-amber-500"></span>
        </span>
        即時雲端數據同步
      </span>
    </div>
  </header>

  <main class="max-w-7xl mx-auto space-y-6">

    <!-- KPI：總淨資產 / 總資產 / 總負債 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="card-bg p-6 rounded-2xl shadow-xl gold-border">
        <p class="text-slate-400 font-medium mb-4">總淨資產 (Net Worth)</p>
        <h2 id="kpi-net-worth" class="text-3xl font-bold text-white mb-1">$0</h2>
        <p class="text-xs text-emerald-400 flex items-center gap-1">最新即時數據</p>
      </div>

      <div class="card-bg p-6 rounded-2xl shadow-xl border-l-4 border-blue-400/50">
        <p class="text-slate-400 font-medium mb-4">總資產 (Total Assets)</p>
        <h2 id="kpi-assets" class="text-3xl font-bold text-white mb-1">$0</h2>
        <p class="text-xs text-blue-300">年度最新資產總額</p>
      </div>

      <div class="card-bg p-6 rounded-2xl shadow-xl border-l-4 border-red-500/50">
        <p class="text-slate-400 font-medium mb-4">總負債 (Liabilities)</p>
        <h2 id="kpi-liabilities" class="text-3xl font-bold text-white mb-1">$0</h2>
        <p class="text-xs text-slate-500">含各類借貸與質押</p>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:colj:col-span-2 card-bg p-6 rounded-2xl shadow-xl h-[450px]">
        <h3 class="text-xl font-bold text-amber-100 mb-6">淨資產增長趨勢</h3>
        <div class="h-[350px]"><canvas id="netWorthChart"></canvas></div>
      </div>

      <div class="card-bg p-6 rounded-2xl shadow-xl h-[450px]">
        <h3 class="text-xl font-bold text-amber-100 mb-6">核心資產配置</h3>
        <div class="h-[280px]"><canvas id="assetAllocationChart"></canvas></div>

        <!-- 4 分類百分比 -->
        <div class="mt-4 space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-slate-400">股票投資</span>
            <span id="label-stock-pct" class="text-white">--%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">現金儲蓄</span>
            <span id="label-cash-pct" class="text-white">--%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">不動產</span>
            <span id="label-re-pct" class="text-white">--%</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-400">其他</span>
            <span id="label-others-pct" class="text-white">--%</span>
          </div>
        </div>
      </div>
    </div>

    <div class="card-bg p-6 rounded-2xl shadow-xl">
      <h3 class="text-xl font-bold text-amber-100 mb-6">每月資產結構明細</h3>
      <div class="h-[350px]"><canvas id="assetStructureChart"></canvas></div>
    </div>

    <div class="card-bg p-6 rounded-2xl shadow-xl">
      <h3 class="text-xl font-bold text-amber-100 mb-6">每月負債結構明細（細項自動同步）</h3>
      <div class="h-[300px]"><canvas id="debtStructureChart"></canvas></div>
      <p id="debtLegendHint" class="mt-3 text-xs text-slate-400"></p>
    </div>
  </main>

  <script>
    // ✅ 你的 Google Apps Script Web App URL（回傳 headers + rows）
    const API_URL = "https://script.google.com/macros/s/AKfycbzBL-nT-F0gHfYDdX-cq-o9ooO6bwcMSZmEQHBCGdNL-hK7RTgAqLn-NZT25izwpwNw/exec";

    let charts = {};

    const fmt = (num) =>
      new Intl.NumberFormat("zh-TW", {
        style: "currency",
        currency: "TWD",
        maximumFractionDigits: 0,
      }).format(Number(num) || 0);

    function destroyChart(key) {
      if (charts[key]) {
        charts[key].destroy();
        delete charts[key];
      }
    }

    async function fetchData() {
      try {
        const resp = await fetch(API_URL, { method: "GET" });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const payload = await resp.json();
        if (!payload || !Array.isArray(payload.headers) || !Array.isArray(payload.rows)) {
          throw new Error("API 回傳格式不是 {headers, rows}");
        }
        return payload;
      } catch (err) {
        console.error("無法抓取數據:", err);
        return { headers: [], rows: [] };
      }
    }

    function idx(headers, name) {
      return headers.findIndex(h => String(h).trim() === name);
    }

    function pickLatestFilledRow(headers, rows) {
      // 以「總資產/淨資產/總負債/股票/現金/不動產/其他」任一有值，視為已填
      const iMonth = idx(headers, "月份");
      const iNet = idx(headers, "淨資產");
      const iAssets = idx(headers, "總資產");
      const iLiab = idx(headers, "總負債");
      const iStock = idx(headers, "股票");
      const iCash = idx(headers, "現金");
      const iRE = idx(headers, "不動產");
      const iOthers = idx(headers, "其他");

      const safe = (r, i) => (i >= 0 ? (Number(r[i]) || 0) : 0);

      const latest = [...rows].reverse().find(r => {
        const sum = safe(r, iNet) + safe(r, iAssets) + safe(r, iLiab) + safe(r, iStock) + safe(r, iCash) + safe(r, iRE) + safe(r, iOthers);
        return sum !== 0; // 允許負數（例如淨資產 -150）
      });

      return latest || rows[0] || null;
    }

    function getMonthLabel(headers, row) {
      const iMonth = idx(headers, "月份");
      if (!row || iMonth < 0) return "---";
      const m = String(row[iMonth]).trim();
      // 如果你表裡是 1~12，這裡轉成 1月…；如果你本來就寫 1月 也 OK
      return m.endsWith("月") ? m : `${m}月`;
    }

    function updateUI(payload) {
      const { headers, rows } = payload;

      const loader = document.getElementById("loader");

      if (!headers.length || !rows.length) {
        loader.style.opacity = "0";
        setTimeout(() => (loader.style.display = "none"), 500);
        return;
      }

      const current = pickLatestFilledRow(headers, rows);

      // KPI indexes
      const iNet = idx(headers, "淨資產");
      const iAssets = idx(headers, "總資產");
      const iLiab = idx(headers, "總負債");

      const netWorth = iNet >= 0 ? (Number(current[iNet]) || 0) : 0;
      const assets = iAssets >= 0 ? (Number(current[iAssets]) || 0) : 0;
      const liab = iLiab >= 0 ? (Number(current[iLiab]) || 0) : 0;

      document.getElementById("latest-month").innerText = `2026年 ${getMonthLabel(headers, current)}`;
      document.getElementById("kpi-net-worth").innerText = fmt(netWorth);
      document.getElementById("kpi-assets").innerText = fmt(assets);
      document.getElementById("kpi-liabilities").innerText = fmt(liab);

      initCharts(payload);

      loader.style.opacity = "0";
      setTimeout(() => (loader.style.display = "none"), 500);
    }

    function initCharts(payload) {
      const { headers, rows } = payload;

      const iMonth = idx(headers, "月份");
      const iNet = idx(headers, "淨資產");
      const iStock = idx(headers, "股票");
      const iCash = idx(headers, "現金");
      const iRE = idx(headers, "不動產");
      const iOthers = idx(headers, "其他");
      const iLiabTotal = idx(headers, "總負債");

      const months = rows.map(r => {
        const m = iMonth >= 0 ? String(r[iMonth]).trim() : "";
        return m.endsWith("月") ? m.replace("月","") : m; // 圖表軸用數字更乾淨（1~12）
      });

      // 1) 淨資產折線圖（直接用「淨資產」欄）
      const netWorthData = rows.map(r => (iNet >= 0 ? (Number(r[iNet]) || 0) : 0));

      destroyChart("netWorth");
      charts.netWorth = new Chart(document.getElementById("netWorthChart"), {
        type: "line",
        data: {
          labels: months,
          datasets: [{
            label: "淨資產",
            data: netWorthData,
            borderColor: "#d4af37",
            backgroundColor: "rgba(212, 175, 55, 0.1)",
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });

      // 最新已填月份
      const current = pickLatestFilledRow(headers, rows);

      // 2) 核心資產配置（股票 / 現金 / 不動產 / 其他）
      const stock = iStock >= 0 ? (Number(current[iStock]) || 0) : 0;
      const cash = iCash >= 0 ? (Number(current[iCash]) || 0) : 0;
      const realEstate = iRE >= 0 ? (Number(current[iRE]) || 0) : 0;
      const others = iOthers >= 0 ? (Number(current[iOthers]) || 0) : 0;

      const totalAssetParts = stock + cash + realEstate + others;
      const pct = (v) => totalAssetParts ? Math.round(v / totalAssetParts * 100) : 0;

      document.getElementById("label-stock-pct").innerText = pct(stock) + "%";
      document.getElementById("label-cash-pct").innerText = pct(cash) + "%";
      document.getElementById("label-re-pct").innerText = pct(realEstate) + "%";
      document.getElementById("label-others-pct").innerText = pct(others) + "%";

      destroyChart("alloc");
      charts.alloc = new Chart(document.getElementById("assetAllocationChart"), {
        type: "doughnut",
        data: {
          labels: ["股票", "現金", "不動產", "其他"],
          datasets: [{
            data: [stock, cash, realEstate, others],
            backgroundColor: ["#d4af37", "#3b82f6", "#059669", "#8b5cf6"],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "80%",
          plugins: { legend: { display: false } }
        }
      });

      // 3) 資產結構（堆疊）：固定四大類（即使你資產欄位之後加細項，也能再做更進階動態）
      destroyChart("assetStructure");
      charts.assetStructure = new Chart(document.getElementById("assetStructureChart"), {
        type: "bar",
        data: {
          labels: months,
          datasets: [
            { label: "不動產", data: rows.map(r => (iRE >= 0 ? (Number(r[iRE]) || 0) : 0)), backgroundColor: "#059669" },
            { label: "股票", data: rows.map(r => (iStock >= 0 ? (Number(r[iStock]) || 0) : 0)), backgroundColor: "#d4af37" },
            { label: "現金", data: rows.map(r => (iCash >= 0 ? (Number(r[iCash]) || 0) : 0)), backgroundColor: "#3b82f6" },
            { label: "其他", data: rows.map(r => (iOthers >= 0 ? (Number(r[iOthers]) || 0) : 0)), backgroundColor: "#8b5cf6" }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { x: { stacked: true }, y: { stacked: true } },
          plugins: { legend: { labels: { color: "#cbd5e1" } } }
        }
      });

      // 4) 負債結構（堆疊）：✅「總負債」後面全部欄位視為負債細項（自動增刪）
      const debtHint = document.getElementById("debtLegendHint");

      if (iLiabTotal < 0) {
        destroyChart("debtStructure");
        debtHint.innerText = "找不到「總負債」欄位，請確認表頭名稱完全一致。";
        return;
      }

      const debtItemStart = iLiabTotal + 1;
      const debtHeaders = headers.slice(debtItemStart).filter(h => String(h).trim() !== "");

      const debtIndexes = debtHeaders.map((h, k) => debtItemStart + k);

      // 沒有細項就提示
      if (!debtHeaders.length) {
        destroyChart("debtStructure");
        debtHint.innerText = "目前「總負債」右側沒有任何負債細項欄位（可在表格右側新增）。";
        return;
      }

      // 生成不同顏色（不用固定色碼，避免你未來欄位很多時要手動）
      const genColor = (i) => `hsl(${(i * 47) % 360} 70% 55%)`;

      const debtDatasets = debtHeaders.map((name, i) => ({
        label: name,
        data: rows.map(r => (Number(r[debtIndexes[i]]) || 0)),
        backgroundColor: genColor(i)
      }));

      destroyChart("debtStructure");
      charts.debtStructure = new Chart(document.getElementById("debtStructureChart"), {
        type: "bar",
        data: {
          labels: months,
          datasets: debtDatasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { x: { stacked: true }, y: { stacked: true } },
          plugins: {
            legend: { labels: { color: "#cbd5e1" } }
          }
        }
      });

      debtHint.innerText = `負債細項：${debtHeaders.join("、")}（自動同步）`;
    }

    window.onload = async () => {
      lucide.createIcons();
      const payload = await fetchData();
      updateUI(payload);
    };
  </script>
</body>
</html>
